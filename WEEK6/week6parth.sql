
CREATE DATABASE newWEEEK6;
USE newWEEEK6;


CREATE TABLE DEPT (
  DEPTNO INT PRIMARY KEY,
  DNAME VARCHAR(50),
  DLOC VARCHAR(50)
);

CREATE TABLE EMPLOYEE (
  EMPNO INT PRIMARY KEY,
  ENAME VARCHAR(50),
  MGR_NO INT,
  HIREDATE DATE,
  SAL DECIMAL(10,2),
  DEPTNO INT,
  FOREIGN KEY (DEPTNO) REFERENCES DEPT(DEPTNO)
);

CREATE TABLE PROJECT (
  PNO INT PRIMARY KEY,
  PNAME VARCHAR(50),
  PLOC VARCHAR(50)
);

CREATE TABLE ASSIGNED_TO (
  EMPNO INT,
  PNO INT,
  JOB_ROLE VARCHAR(50),
  PRIMARY KEY (EMPNO, PNO),
  FOREIGN KEY (EMPNO) REFERENCES EMPLOYEE(EMPNO),
  FOREIGN KEY (PNO) REFERENCES PROJECT(PNO)
);

CREATE TABLE INCENTIVES (
  EMPNO INT,
  INCENTIVE_DATE DATE,
  INCENTIVE_AMOUNT DECIMAL(10,2),
  FOREIGN KEY (EMPNO) REFERENCES EMPLOYEE(EMPNO)
);


INSERT INTO DEPT (DEPTNO, DNAME, DLOC) VALUES
(10, 'HR', 'Bengaluru'),
(20, 'Finance', 'Hyderabad'),
(30, 'Engineering', 'Mysuru'),
(40, 'Marketing', 'Chennai'),
(50, 'Operations', 'Delhi');


INSERT INTO EMPLOYEE (EMPNO, ENAME, MGR_NO, HIREDATE, SAL, DEPTNO) VALUES
(1001, 'Amit', 2001, '2020-01-15', 60000, 10),
(1002, 'Priya', 2002, '2019-03-22', 75000, 20),
(1003, 'Rahul', 2001, '2021-07-10', 80000, 30),
(1004, 'Sneha', 2003, '2022-11-05', 55000, 40),
(1005, 'Kiran', 2002, '2020-06-18', 72000, 50);

INSERT INTO EMPLOYEE (EMPNO, ENAME, MGR_NO, HIREDATE, SAL, DEPTNO) VALUES
(2001, 'Ramesh', NULL, '2015-05-10', 90000, 10),
(2002, 'Divya', NULL, '2016-03-12', 85000, 20),
(2003, 'Suresh', NULL, '2017-07-01', 95000, 30);

INSERT INTO EMPLOYEE (EMPNO, ENAME, MGR_NO, HIREDATE, SAL, DEPTNO) VALUES
(3001, 'Anita', 2001, '2020-09-10', 70000, 10),
(3002, 'Vikram', 2002, '2021-02-15', 68000, 20);


INSERT INTO PROJECT (PNO, PNAME, PLOC) VALUES
(501, 'Apollo', 'Bengaluru'),
(502, 'Zeus', 'Hyderabad'),
(503, 'Hermes', 'Mysuru'),
(504, 'Athena', 'Chennai'),
(505, 'Poseidon', 'Delhi');


INSERT INTO ASSIGNED_TO (EMPNO, PNO, JOB_ROLE) VALUES
(1001, 501, 'Analyst'),
(1002, 502, 'Accountant'),
(1003, 503, 'Developer'),
(1004, 504, 'Coordinator'),
(1005, 505, 'Supervisor');


INSERT INTO INCENTIVES (EMPNO, INCENTIVE_DATE, INCENTIVE_AMOUNT) VALUES
(1001, '2023-12-01', 5000),
(1002, '2023-11-15', 7000),
(1003, '2024-01-10', 6000),
(1004, '2024-02-20', 4500),
(1001, '2024-03-05', 3000),

(1001, '2019-01-05', 4000),
(1002, '2019-01-10', 7000),
(1003, '2019-01-15', 5000);



SELECT E.ENAME AS Manager_Name
FROM EMPLOYEE E
JOIN EMPLOYEE M ON E.EMPNO = M.MGR_NO
GROUP BY E.EMPNO, E.ENAME
HAVING COUNT(M.EMPNO) = (
    SELECT MAX(EmpCount)
    FROM (
        SELECT MGR_NO, COUNT(*) AS EmpCount
        FROM EMPLOYEE
        WHERE MGR_NO IS NOT NULL
        GROUP BY MGR_NO
    ) AS Temp
);

SELECT DISTINCT M.ENAME AS Manager_Name
FROM EMPLOYEE M
JOIN EMPLOYEE E ON M.EMPNO = E.MGR_NO
GROUP BY M.EMPNO, M.ENAME, M.SAL
HAVING M.SAL > AVG(E.SAL);

SELECT DISTINCT E.ENAME AS Second_Top_Level_Manager, D.DNAME
FROM EMPLOYEE E
JOIN EMPLOYEE M ON E.MGR_NO = M.EMPNO
JOIN DEPT D ON E.DEPTNO = D.DEPTNO
WHERE M.MGR_NO IS NULL;

SELECT *
FROM EMPLOYEE
WHERE EMPNO = (
    SELECT EMPNO
    FROM INCENTIVES
    WHERE MONTH(INCENTIVE_DATE) = 1 AND YEAR(INCENTIVE_DATE) = 2019
    ORDER BY INCENTIVE_AMOUNT DESC
    LIMIT 1 OFFSET 1
);

SELECT E.ENAME AS Employee_Name, M.ENAME AS Manager_Name, D.DNAME AS Department
FROM EMPLOYEE E
JOIN EMPLOYEE M ON E.MGR_NO = M.EMPNO
JOIN DEPT D ON E.DEPTNO = D.DEPTNO
WHERE E.DEPTNO = M.DEPTNO;
